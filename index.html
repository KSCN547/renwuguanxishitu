<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>3Däººç‰©å…³ç³»æ¡£æ¡ˆ - é«˜ç¨³å®šæ€§ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/3d-force-graph@1.73.2/dist/3d-force-graph.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; }
        body { margin: 0; background: #e3f2fd; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; }
        .ui-overlay { position: absolute; z-index: 99; pointer-events: auto; }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: center; z-index: 10000; font-weight: bold; color: var(--primary); }
        #ui-panel { top: 15px; left: 15px; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; width: 240px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; display: none; }
        #detail-card { top: 70px; right: 15px; background: white; padding: 20px; border-radius: 12px; width: 300px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-left: 8px solid var(--primary); }
        .search-box { top: 15px; right: 15px; width: 280px; }
        .search-box input { width: 100%; padding: 12px 18px; border-radius: 25px; border: 2px solid var(--primary); outline: none; }
        input, select, textarea { width: 100%; margin: 5px 0; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; margin-top: 5px; background: var(--primary); color: white; }
        #sync-text { font-size: 11px; color: #666; text-align: center; margin: 5px 0; }
    </style>
</head>
<body>

    <div id="loading-screen">ğŸš€ æ­£åœ¨å¯åŠ¨ 3D æ¸²æŸ“å¼•æ“ï¼Œè¯·ç¨å€™...</div>

    <div class="ui-overlay search-box">
        <input type="text" placeholder="ğŸ” æœç´¢å§“å/å¤–å·..." oninput="handleSearch(this.value)" onclick="handleSecretClick()">
    </div>

    <div id="ui-panel" class="ui-overlay">
        <h4 style="margin:0">ğŸ‘¤ èµ„æ–™å½•å…¥</h4>
        <input type="text" id="nodeName" placeholder="å§“å">
        <input type="text" id="nodeNick" placeholder="å¤–å· (é€—å·éš”å¼€)">
        <input type="text" id="nodeAvatar" placeholder="å¤´åƒ URL">
        <textarea id="nodeDesc" placeholder="ç®€ä»‹..." rows="2"></textarea>
        <button onclick="addNode()">ä¿å­˜äººç‰©</button>
        <hr style="opacity:0.1">
        <h4 style="margin:0">ğŸ”— å»ºç«‹å…³ç³»</h4>
        <input type="text" id="source" placeholder="ç”²æ–¹å§“å">
        <input type="text" id="target" placeholder="ä¹™æ–¹å§“å">
        <select id="relType">
            <option value="cp">CP</option>
            <option value="å¥½å‹">å¥½å‹</option>
            <option value="ä»‡äºº">ä»‡äºº</option>
        </select>
        <button style="background:var(--success)" onclick="addLink()">ç¡®è®¤è¿æ¥</button>
        <div id="sync-text">ğŸ“¡ çŠ¶æ€: å°±ç»ª</div>
        <button onclick="logout()" style="background:#6c757d; font-size:10px">é€€å‡ºç®¡ç†</button>
    </div>

    <div id="detail-card" class="ui-overlay">
        <div style="text-align:center">
            <img id="c-avatar" style="width:70px;height:70px;border-radius:50%;object-fit:cover;border:2px solid var(--primary)">
            <h3 id="c-name" style="margin:8px 0"></h3>
        </div>
        <p id="c-desc" style="font-size:13px; color:#555;"></p>
        <div style="margin-top:15px">
            <button id="delBtn" style="background:var(--danger); display:none" onclick="deleteNode()">âš ï¸ åˆ é™¤æ­¤äºº</button>
            <button onclick="closeCard()" style="background:#eee; color:#666">å…³é—­</button>
        </div>
    </div>

    <div id="3d-graph"></div>

    <script>
        const SB_URL = 'https://qemyaqsxlkxpxvmlzhli.supabase.co';
        const SB_KEY = 'sb_publishable_QB7wPNVsq0olx3opmZXDzA_83yJm1qD';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let gData = { nodes: [], links: [] }, focusNode = null, isAdmin = false;
        const REL_STYLE = { 'cp': '#B3005F', 'å¥½å‹': '#006400', 'ä»‡äºº': '#800000' };

        // 1. å…ˆåˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ Graph å¯¹è±¡
        const Graph = ForceGraph3D()(document.getElementById('3d-graph'));

        // 2. é…ç½® Graph æ¸²æŸ“å‚æ•°ï¼ˆæ­¤æ—¶ä¸æ³¨å…¥æ•°æ®ï¼‰
        Graph.backgroundColor('#f0f8ff')
            .nodeThreeObject(node => {
                // æ­¤æ—¶ THREE å·²ç»ä» cdn åŠ è½½ï¼Œç»å¯¹ä¸ä¼šæŠ¥é”™
                const group = new THREE.Group();
                const isFocus = focusNode && node.id === focusNode.id;
                const size = isFocus ? 11 : 7;
                
                const img = node.avatar || `https://api.dicebear.com/7.x/initials/svg?seed=${node.id}`;
                const texture = new THREE.TextureLoader().load(img);
                const sphere = new THREE.Mesh(new THREE.SphereGeometry(size, 32, 32), new THREE.MeshLambertMaterial({ map: texture }));
                group.add(sphere);

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 120; canvas.height = 40;
                ctx.fillStyle = 'rgba(0,0,0,0.6)';
                ctx.fillRect(0, 0, 120, 40);
                ctx.font = 'bold 20px Arial'; ctx.fillStyle = 'white'; ctx.textAlign = 'center';
                ctx.fillText(node.id, 60, 28);
                
                const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas) }));
                sprite.position.y = size + 6; sprite.scale.set(12, 4, 1);
                group.add(sprite);
                return group;
            })
            .linkColor(l => REL_STYLE[l.type] || '#666')
            .linkWidth(1.5)
            .onNodeClick(node => { focusNode = node; showDetail(node); Graph.refresh(); });

        // 3. æ•°æ®æ¸…æ´—å‡½æ•°ï¼ˆè§£å†³çƒçº¿åˆ†ç¦»æ ¸å¿ƒï¼‰
        function cleanData(rawData) {
            const data = JSON.parse(JSON.stringify(rawData));
            data.nodes.forEach(n => {
                ['x','y','z','vx','vy','vz','fx','fy','fz'].forEach(prop => delete n[prop]);
            });
            data.links.forEach(l => {
                if (typeof l.source === 'object') l.source = l.source.id;
                if (typeof l.target === 'object') l.target = l.target.id;
            });
            return data;
        }

        // 4. ç­‰å¾…å¼•æ“å’Œæ•°æ®å…¨éƒ¨å‡†å¤‡å°±ç»ª
        async function startApp() {
            try {
                // åŠ è½½æ•°æ®
                const { data, error } = await sb.from('relation_graphs').select('data').eq('id', 1).single();
                
                if (!error && data) {
                    gData = cleanData(data.data);
                    // å»¶è¿Ÿ 500ms ç¡®ä¿æµè§ˆå™¨æ¸²æŸ“ä¸Šä¸‹æ–‡å®Œå…¨å°±ç»ª
                    setTimeout(() => {
                        Graph.graphData(gData);
                        document.getElementById('loading-screen').style.display = 'none';
                        console.log("å¼•æ“åˆå§‹åŒ–å®Œæˆï¼Œæ•°æ®å·²æ³¨å…¥");
                    }, 500);
                }
                
                // æ£€æŸ¥æƒé™
                const { data: { user } } = await sb.auth.getUser();
                if (user) {
                    isAdmin = true;
                    document.getElementById('ui-panel').style.display = 'block';
                    document.getElementById('delBtn').style.display = 'block';
                }
            } catch (e) {
                console.error("å¯åŠ¨å¤±è´¥", e);
            }
        }

        // ç®¡ç†å‘˜åŠŸèƒ½
        async function saveData() {
            if (!isAdmin) return;
            document.getElementById('sync-text').innerText = "â³ æ­£åœ¨åŒæ­¥...";
            const dataToSave = cleanData(gData);
            const { error } = await sb.from('relation_graphs').update({ data: dataToSave }).eq('id', 1);
            document.getElementById('sync-text').innerText = error ? "âŒ å¤±è´¥" : "âœ… å·²åŒæ­¥";
        }

        function addNode() {
            const name = document.getElementById('nodeName').value.trim();
            if (!name) return;
            const info = {
                id: name,
                avatar: document.getElementById('nodeAvatar').value,
                nicks: document.getElementById('nodeNick').value.split(/[,ï¼Œ]/).filter(t => t),
                desc: document.getElementById('nodeDesc').value
            };
            const idx = gData.nodes.findIndex(n => n.id === name);
            if (idx > -1) gData.nodes[idx] = info; else gData.nodes.push(info);
            Graph.graphData(cleanData(gData)); saveData();
        }

        function addLink() {
            const s = document.getElementById('source').value.trim();
            const t = document.getElementById('target').value.trim();
            if (!s || !t) return;
            gData.links.push({ source: s, target: t, type: document.getElementById('relType').value });
            Graph.graphData(cleanData(gData)); saveData();
        }

        function deleteNode() {
            if (!focusNode || !confirm(`ç¡®è®¤åˆ é™¤ ${focusNode.id}ï¼Ÿ`)) return;
            const id = focusNode.id;
            gData.nodes = gData.nodes.filter(n => n.id !== id);
            gData.links = gData.links.filter(l => (l.source.id || l.source) !== id && (l.target.id || l.target) !== id);
            closeCard(); Graph.graphData(cleanData(gData)); saveData();
        }

        function showDetail(node) {
            document.getElementById('c-name').innerText = node.id;
            document.getElementById('c-avatar').src = node.avatar || '';
            document.getElementById('c-desc').innerText = node.desc || 'æ— èµ„æ–™';
            document.getElementById('detail-card').style.display = 'block';
        }

        function handleSecretClick() {
            window.clickCount = (window.clickCount || 0) + 1;
            if (window.clickCount >= 3) {
                const email = prompt("ç®¡ç†é‚®ç®±:"); const pw = prompt("å¯†ç :");
                sb.auth.signInWithPassword({ email, password: pw }).then(({ error }) => {
                    if (!error) location.reload();
                });
            }
            setTimeout(() => window.clickCount = 0, 1000);
        }

        async function logout() { await sb.auth.signOut(); location.reload(); }
        function closeCard() { document.getElementById('detail-card').style.display = 'none'; focusNode = null; Graph.refresh(); }
        function handleSearch(v) {
            const n = gData.nodes.find(n => n.id.includes(v));
            if (n) { focusNode = n; showDetail(n); Graph.refresh(); }
        }

        // å¯åŠ¨æµç¨‹
        window.onload = startApp;
    </script>
</body>
</html>
