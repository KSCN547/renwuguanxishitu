<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>3Däººç‰©å…³ç³»æ¡£æ¡ˆ</title>
    <script src="https://unpkg.com/3d-force-graph@1.73.2/dist/3d-force-graph.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; }
        body { margin: 0; background-color: #e3f2fd; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; }
        .ui-overlay { position: absolute; z-index: 9999; pointer-events: auto; }
        #ui-panel { top: 15px; left: 15px; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; width: 250px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; display: none; }
        #detail-card { top: 70px; right: 15px; background: white; padding: 20px; border-radius: 12px; width: 320px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-left: 8px solid var(--primary); }
        .search-box { top: 15px; right: 15px; width: 280px; }
        .search-box input { width: 100%; padding: 12px 18px; border-radius: 25px; border: 2px solid var(--primary); outline: none; background: white; font-weight: bold; cursor: pointer; }
        input, select, textarea { width: 100%; margin: 6px 0; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; margin-top: 8px; background: var(--primary); color: white; transition: 0.2s; }
        .tag { background: #e7f3ff; color: #007bff; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin: 2px; display: inline-block; }
        .rel-table { width: 100%; font-size: 12px; margin-top: 15px; border-collapse: collapse; }
        .rel-table td { border-bottom: 1px solid #eee; padding: 10px 4px; }
        #sync-text { font-size: 12px; color: #666; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="ui-overlay search-box">
        <input type="text" placeholder="ğŸ” æœç´¢å§“åæˆ–å¤–å·..." oninput="handleSearch(this.value)" onclick="handleSecretClick()">
    </div>

    <div id="ui-panel" class="ui-overlay">
        <h3 style="margin:0 0 10px 0;">ğŸ‘¤ æ¡£æ¡ˆå½•å…¥</h3>
        <input type="text" id="nodeName" placeholder="å§“å (å¿…å¡«)">
        <input type="text" id="nodeNick" placeholder="å¤–å· (é€—å·éš”å¼€)">
        <input type="text" id="nodeAvatar" placeholder="å›¾ç‰‡ URL">
        <textarea id="nodeDesc" placeholder="äººç‰©èƒŒæ™¯ç®€ä»‹..." rows="2"></textarea>
        <button onclick="addNode()">ä¿å­˜èµ„æ–™</button>
        <hr style="opacity:0.1">
        <h3 style="margin:0 0 10px 0;">ğŸ”— å»ºç«‹è¿æ¥</h3>
        <input type="text" id="source" placeholder="ç”²æ–¹å§“å">
        <input type="text" id="target" placeholder="ä¹™æ–¹å§“å">
        <select id="relType">
            <option value="cp">CP</option>
            <option value="å¥½å‹">å¥½å‹</option>
            <option value="ä»‡äºº">ä»‡äºº</option>
        </select>
        <textarea id="relDesc" placeholder="æè¿°è¿™æ®µå…³ç³»..." rows="2"></textarea>
        <button style="background:var(--success)" onclick="addLink()">ç¡®è®¤å»ºç«‹</button>
        <div id="sync-text">ğŸ“¡ å‡†å¤‡å°±ç»ª</div>
    </div>

    <div id="detail-card" class="ui-overlay">
        <div style="text-align:center">
            <img id="c-avatar" src="" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">
            <h2 id="c-name" style="margin:10px 0 5px 0;"></h2>
            <div id="c-nicks"></div>
        </div>
        <p id="c-desc" style="font-size:13px; color:#555;"></p>
        <table class="rel-table"><tbody id="c-rel-body"></tbody></table>
        <button onclick="closeCard()">å…³é—­</button>
    </div>

    <div id="3d-graph"></div>

    <script>
        const SB_URL = 'https://qemyaqsxlkxpxvmlzhli.supabase.co';
        const SB_KEY = 'sb_publishable_QB7wPNVsq0olx3opmZXDzA_83yJm1qD';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let gData = { nodes: [], links: [] };
        let focusNode = null;
        let isAdmin = false;

        const REL_STYLE = { 'cp': '#B3005F', 'å¥½å‹': '#006400', 'ä»‡äºº': '#800000' };

        const Graph = ForceGraph3D()(document.getElementById('3d-graph'));

        Graph.backgroundColor('#f0f8ff')
            .showNavInfo(false)
            .nodeThreeObject(node => {
                // åŠ¨æ€è·å– THREEï¼Œè§£å†³ Group undefined æŠ¥é”™
                const THREE = Graph.renderer().getContext().canvas.ownerDocument.defaultView.THREE;
                const group = new THREE.Group();
                const size = (focusNode && node.id === focusNode.id) ? 11 : 7;
                
                const img = node.avatar || `https://api.dicebear.com/7.x/initials/svg?seed=${node.id}`;
                const texture = new THREE.TextureLoader().load(img);
                const sphere = new THREE.Mesh(new THREE.SphereGeometry(size, 32, 32), new THREE.MeshLambertMaterial({ map: texture }));
                group.add(sphere);

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 160; canvas.height = 40;
                ctx.fillStyle = 'rgba(0,0,0,0.6)';
                ctx.fillRect(0, 0, 160, 40);
                ctx.font = 'bold 24px Arial'; ctx.fillStyle = 'white'; ctx.textAlign = 'center';
                ctx.fillText(node.id, 80, 28);
                
                const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas) }));
                sprite.position.y = size + 6;
                sprite.scale.set(16, 4, 1);
                group.add(sprite);
                return group;
            })
            .linkColor(link => REL_STYLE[link.type] || '#666')
            .onNodeClick(node => { focusNode = node; showDetail(node); Graph.refresh(); });

        async function loadData() {
            const { data, error } = await sb.from('relation_graphs').select('data').eq('id', 1).single();
            if (!error && data) {
                gData = JSON.parse(JSON.stringify(data.data));
                // æ¸…ç†æ—§åæ ‡ï¼Œé˜²æ­¢é”™ä½
                gData.nodes.forEach(n => { delete n.x; delete n.y; delete n.z; });
                gData.links.forEach(l => {
                    if (typeof l.source === 'object') l.source = l.source.id;
                    if (typeof l.target === 'object') l.target = l.target.id;
                });
                Graph.graphData(gData);
                document.getElementById('sync-text').innerText = "âœ… æ•°æ®åŒæ­¥æˆåŠŸ";
            }
            checkAdmin();
        }

        async function checkAdmin() {
            const { data: { user } } = await sb.auth.getUser();
            if (user) { isAdmin = true; document.getElementById('ui-panel').style.display = 'block'; }
        }

        let clickCount = 0;
        function handleSecretClick() {
            clickCount++;
            if (clickCount >= 3) { login(); clickCount = 0; }
            setTimeout(() => clickCount = 0, 1000);
        }

        async function login() {
            const email = prompt("ç®¡ç†é‚®ç®±:"); const pw = prompt("å¯†ç :");
            const { error } = await sb.auth.signInWithPassword({ email, password: pw });
            if (!error) location.reload();
        }

        function showDetail(node) {
            document.getElementById('c-avatar').src = node.avatar || '';
            document.getElementById('c-name').innerText = node.id;
            document.getElementById('c-desc').innerText = node.desc || '';
            document.getElementById('detail-card').style.display = 'block';
        }

        function closeCard() { document.getElementById('detail-card').style.display = 'none'; focusNode = null; Graph.refresh(); }

        window.onload = loadData;
    </script>
</body>
</html>
