<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>3Däººç‰©å…³ç³»æ¡£æ¡ˆ</title>
    <script src="https://unpkg.com/3d-force-graph@1.73.2/dist/3d-force-graph.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; }
        body { margin: 0; background: #e3f2fd; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; }
        .ui-overlay { position: absolute; z-index: 99; pointer-events: auto; }
        #ui-panel { top: 15px; left: 15px; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; width: 240px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; display: none; }
        #detail-card { top: 70px; right: 15px; background: white; padding: 20px; border-radius: 12px; width: 300px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-left: 8px solid var(--primary); }
        .search-box { top: 15px; right: 15px; width: 280px; }
        .search-box input { width: 100%; padding: 12px 18px; border-radius: 25px; border: 2px solid var(--primary); outline: none; }
        input, select, textarea { width: 100%; margin: 5px 0; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; margin-top: 5px; background: var(--primary); color: white; }
        .tag { background: #e7f3ff; color: #007bff; padding: 3px 8px; border-radius: 5px; font-size: 11px; margin: 2px; display: inline-block; }
        .rel-table { width: 100%; font-size: 12px; margin-top: 10px; border-collapse: collapse; }
        .rel-table td { border-bottom: 1px solid #eee; padding: 8px 2px; }
        #sync-text { font-size: 11px; color: #666; text-align: center; margin: 5px 0; }
    </style>
</head>
<body>

    <div class="ui-overlay search-box">
        <input type="text" placeholder="ğŸ” æœç´¢å§“å/å¤–å·..." oninput="handleSearch(this.value)" onclick="handleSecretClick()">
    </div>

    <div id="ui-panel" class="ui-overlay">
        <h4 style="margin:0">ğŸ‘¤ èµ„æ–™å½•å…¥</h4>
        <input type="text" id="nodeName" placeholder="å§“å">
        <input type="text" id="nodeNick" placeholder="å¤–å· (é€—å·éš”å¼€)">
        <input type="text" id="nodeAvatar" placeholder="å¤´åƒ URL">
        <textarea id="nodeDesc" placeholder="ç®€ä»‹..." rows="2"></textarea>
        <button onclick="addNode()">ä¿å­˜äººç‰©</button>
        <hr style="opacity:0.1">
        <h4 style="margin:0">ğŸ”— å»ºç«‹å…³ç³»</h4>
        <input type="text" id="source" placeholder="ç”²æ–¹å§“å">
        <input type="text" id="target" placeholder="ä¹™æ–¹å§“å">
        <select id="relType">
            <option value="cp">CP (æ·±ç«çº¢)</option>
            <option value="å¥½å‹">å¥½å‹ (ç¿¡ç¿ ç»¿)</option>
            <option value="é˜Ÿå‹">é˜Ÿå‹ (æ·±æµ·è“)</option>
            <option value="ä»‡äºº">ä»‡äºº (æœ±ç ‚çº¢)</option>
        </select>
        <button style="background:var(--success)" onclick="addLink()">ç¡®è®¤è¿æ¥</button>
        <div id="sync-text">ğŸ“¡ äº‘ç«¯å°±ç»ª</div>
        <button onclick="logout()" style="background:#6c757d; font-size:10px">é€€å‡ºç®¡ç†</button>
    </div>

    <div id="detail-card" class="ui-overlay">
        <div style="text-align:center">
            <img id="c-avatar" style="width:70px;height:70px;border-radius:50%;object-fit:cover;border:2px solid var(--primary)">
            <h3 id="c-name" style="margin:8px 0"></h3>
            <div id="c-nicks"></div>
        </div>
        <p id="c-desc" style="font-size:13px; color:#555; line-height:1.4"></p>
        <table class="rel-table"><tbody id="c-rel-body"></tbody></table>
        <div style="margin-top:15px">
            <button id="delNodeBtn" onclick="deleteCurrentNode()" style="background:var(--danger); display:none">âš ï¸ åˆ é™¤æ­¤äºº</button>
            <button onclick="closeCard()" style="background:#eee; color:#666">å…³é—­</button>
        </div>
    </div>

    <div id="3d-graph"></div>

    <script>
        const SB_URL = 'https://qemyaqsxlkxpxvmlzhli.supabase.co';
        const SB_KEY = 'sb_publishable_QB7wPNVsq0olx3opmZXDzA_83yJm1qD';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let gData = { nodes: [], links: [] }, focusNode = null, isAdmin = false;
        const REL_STYLE = { 'cp': '#880044', 'å¥½å‹': '#004400', 'é˜Ÿå‹': '#003344', 'ä»‡äºº': '#660000' };

        const Graph = ForceGraph3D()(document.getElementById('3d-graph'))
            .backgroundColor('#f0f8ff')
            .nodeThreeObject(node => {
                // åŠ¨æ€è·å– THREEï¼Œè§£å†³ undefined æŠ¥é”™
                const THREE = Graph.renderer().getContext().canvas.ownerDocument.defaultView.THREE;
                const isFocus = focusNode && node.id === focusNode.id;
                const group = new THREE.Group();
                const size = isFocus ? 11 : 7;
                
                const texture = new THREE.TextureLoader().load(node.avatar || `https://api.dicebear.com/7.x/initials/svg?seed=${node.id}`);
                const sphere = new THREE.Mesh(new THREE.SphereGeometry(size, 32, 32), new THREE.MeshLambertMaterial({ map: texture }));
                group.add(sphere);

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 120; canvas.height = 40;
                ctx.fillStyle = isFocus ? '#007bff' : '#555';
                ctx.beginPath(); ctx.roundRect(0, 0, 120, 40, 8); ctx.fill();
                ctx.font = '20px Arial'; ctx.fillStyle = 'white'; ctx.textAlign = 'center';
                ctx.fillText(node.id, 60, 28);
                
                const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas) }));
                sprite.position.y = size + 6; sprite.scale.set(12, 4, 1);
                group.add(sprite);
                return group;
            })
            .linkColor(l => REL_STYLE[l.type] || '#999')
            .onNodeClick(node => { focusNode = node; showDetail(node); Graph.refresh(); });

        async function loadData() {
            const { data } = await sb.from('relation_graphs').select('data').eq('id', 1).single();
            if (data) { gData = data.data; Graph.graphData(gData); }
            const { data: { user } } = await sb.auth.getUser();
            if (user) {
                isAdmin = true;
                document.getElementById('ui-panel').style.display = 'block';
                document.getElementById('delNodeBtn').style.display = 'block';
            }
        }

        async function saveData() {
            if (!isAdmin) return;
            document.getElementById('sync-text').innerText = "â³ åŒæ­¥ä¸­...";
            const cleanData = JSON.parse(JSON.stringify(gData));
            cleanData.nodes.forEach(n => ['x','y','z','vx','vy','vz','fx','fy','fz'].forEach(p => delete n[p]));
            const { error } = await sb.from('relation_graphs').update({ data: cleanData }).eq('id', 1);
            document.getElementById('sync-text').innerText = error ? "âŒ å¤±è´¥" : "âœ… å·²åŒæ­¥";
        }

        function addNode() {
            const name = document.getElementById('nodeName').value.trim();
            if (!name) return;
            const node = gData.nodes.find(n => n.id === name);
            const info = {
                id: name,
                avatar: document.getElementById('nodeAvatar').value,
                nicks: document.getElementById('nodeNick').value.split(/[,ï¼Œ]/).filter(t => t),
                desc: document.getElementById('nodeDesc').value
            };
            if (node) Object.assign(node, info); else gData.nodes.push(info);
            Graph.graphData(gData); saveData();
        }

        function addLink() {
            const s = document.getElementById('source').value.trim();
            const t = document.getElementById('target').value.trim();
            if (!s || !t) return;
            gData.links.push({ source: s, target: t, type: document.getElementById('relType').value });
            Graph.graphData(gData); saveData();
        }

        function deleteCurrentNode() {
            if (!focusNode || !confirm(`ç¡®å®šåˆ é™¤ ${focusNode.id} åŠå…¶æ‰€æœ‰å…³ç³»å—ï¼Ÿ`)) return;
            const id = focusNode.id;
            gData.nodes = gData.nodes.filter(n => n.id !== id);
            gData.links = gData.links.filter(l => (l.source.id || l.source) !== id && (l.target.id || l.target) !== id);
            closeCard(); Graph.graphData(gData); saveData();
        }

        function deleteLink(idx) {
            if (!confirm("åˆ é™¤æ­¤æ¡å…³ç³»ï¼Ÿ")) return;
            gData.links.splice(idx, 1);
            Graph.graphData(gData); saveData(); showDetail(focusNode);
        }

        function showDetail(node) {
            document.getElementById('c-name').innerText = node.id;
            document.getElementById('c-avatar').src = node.avatar || '';
            document.getElementById('c-desc').innerText = node.desc || 'æ— èƒŒæ™¯ä»‹ç»';
            document.getElementById('c-nicks').innerHTML = (node.nicks || []).map(n => `<span class="tag">#${n}</span>`).join('');
            
            const myLinks = gData.links.filter(l => (l.source.id || l.source) === node.id || (l.target.id || l.target) === node.id);
            document.getElementById('c-rel-body').innerHTML = myLinks.map(l => {
                const other = (l.source.id || l.source) === node.id ? (l.target.id || l.target) : (l.source.id || l.source);
                const del = isAdmin ? `<td onclick="deleteLink(${gData.links.indexOf(l)})" style="color:red;cursor:pointer">Ã—</td>` : '';
                return `<tr><td><b>${other}</b></td><td style="color:${REL_STYLE[l.type]}">${l.type}</td>${del}</tr>`;
            }).join('');
            document.getElementById('detail-card').style.display = 'block';
        }

        function handleSearch(v) {
            const n = gData.nodes.find(n => n.id.includes(v) || (n.nicks && n.nicks.some(nk => nk.includes(v))));
            if (n) { focusNode = n; showDetail(n); Graph.refresh(); }
        }

        let count = 0;
        function handleSecretClick() {
            count++; if (count >= 3) {
                const p = prompt("ç®¡ç†å¯†ç :");
                if (p) sb.auth.signInWithPassword({email:'admin@test.com', password:p}).then(({error}) => error ? alert('é”™è¯¯') : location.reload());
            }
            setTimeout(() => count = 0, 1000);
        }

        async function logout() { await sb.auth.signOut(); location.reload(); }
        function closeCard() { document.getElementById('detail-card').style.display = 'none'; focusNode = null; Graph.refresh(); }
        
        window.onload = loadData;
    </script>
</body>
</html>
