<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>3Däººç‰©å…³ç³»æ¡£æ¡ˆ - æœ€ç»ˆå®Œå–„ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/3d-force-graph@1.73.2/dist/3d-force-graph.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; }
        body { margin: 0; background-color: #e3f2fd; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; }
        .ui-overlay { position: absolute; z-index: 9999; pointer-events: auto; }
        #ui-panel { top: 15px; left: 15px; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; width: 250px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; display: none; }
        #detail-card { top: 70px; right: 15px; background: white; padding: 20px; border-radius: 12px; width: 320px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-left: 8px solid var(--primary); }
        .search-box { top: 15px; right: 15px; width: 280px; }
        .search-box input { width: 100%; padding: 12px 18px; border-radius: 25px; border: 2px solid var(--primary); outline: none; background: white; font-weight: bold; }
        input, select, textarea { width: 100%; margin: 6px 0; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; margin-top: 8px; background: var(--primary); color: white; transition: 0.2s; }
        button:hover { filter: brightness(1.1); }
        .upload-label { display: block; background: #f8f9fa; padding: 8px; border-radius: 8px; text-align: center; font-size: 12px; cursor: pointer; border: 1px dashed #aaa; margin: 5px 0; }
        .tag { background: #e7f3ff; color: #007bff; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin: 2px; display: inline-block; font-weight: bold; }
        .rel-table { width: 100%; font-size: 12px; margin-top: 15px; border-collapse: collapse; }
        .rel-table td { border-bottom: 1px solid #eee; padding: 10px 4px; }
        .link-tooltip { position: absolute; background: rgba(255,255,255,0.98); color: #222; padding: 12px; border-radius: 10px; font-size: 14px; z-index: 10000; display: none; pointer-events: none; border: 1px solid #ccc; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #sync-text { font-size: 12px; color: #666; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="ui-overlay search-box">
        <input type="text" placeholder="ğŸ” æœç´¢å§“åæˆ–å¤–å·..." oninput="handleSearch(this.value)" onclick="handleSecretClick()">
    </div>

    <div id="ui-panel" class="ui-overlay">
        <h3 style="margin:0 0 10px 0; color:#333">ğŸ‘¤ æ¡£æ¡ˆå½•å…¥</h3>
        <input type="text" id="nodeName" placeholder="å§“å (å¿…å¡«)">
        <input type="text" id="nodeNick" placeholder="å¤–å· (é€—å·éš”å¼€)">
        <label class="upload-label">ğŸ“ ä¸Šä¼ å¤´åƒå›¾ç‰‡<input type="file" accept="image/*" style="display:none" onchange="handleImg(this)"></label>
        <input type="text" id="nodeAvatar" placeholder="æˆ–è€…å›¾ç‰‡URL">
        <textarea id="nodeDesc" placeholder="äººç‰©èƒŒæ™¯ç®€ä»‹..." rows="2"></textarea>
        <button onclick="addNode()">ä¿å­˜èµ„æ–™</button>
        <hr style="margin:15px 0; opacity:0.1">
        <h3 style="margin:0 0 10px 0; color:#333">ğŸ”— å»ºç«‹è¿æ¥</h3>
        <input type="text" id="source" placeholder="ç”²æ–¹å§“å">
        <input type="text" id="target" placeholder="ä¹™æ–¹å§“å">
        <select id="relType">
            <option value="cp">CP (æ·±ç«çº¢)</option>
            <option value="å¥½å‹">å¥½å‹ (ç¿¡ç¿ ç»¿)</option>
            <option value="é˜Ÿå‹">é˜Ÿå‹ (æ·±æµ·è“)</option>
            <option value="å®¤å‹">å®¤å‹ (ç„¦ç³–æ©™)</option>
            <option value="becp">BECP (æš—é›ç´«)</option>
            <option value="ä»‡äºº">ä»‡äºº (æœ±ç ‚çº¢)</option>
        </select>
        <textarea id="relDesc" placeholder="æè¿°è¿™æ®µå…³ç³»..." rows="2"></textarea>
        <button style="background:var(--success)" onclick="addLink()">ç¡®è®¤å»ºç«‹</button>
        <div id="sync-text">ğŸ“¡ å‡†å¤‡å°±ç»ª</div>
        <button onclick="logout()" style="background:#6c757d; margin-top: 15px; font-size: 11px;">ğŸ”’ é€€å‡ºç®¡ç†æ¨¡å¼</button>
    </div>

    <div id="detail-card" class="ui-overlay">
        <div style="text-align:center">
            <img id="c-avatar" src="" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--primary)">
            <h2 id="c-name" style="margin:10px 0 5px 0; color:#333"></h2>
            <div id="c-nicks"></div>
        </div>
        <p id="c-desc" style="font-size:13px; color:#555; margin:10px 0; line-height:1.5; background:#f5faff; padding:8px; border-radius:6px"></p>
        <div style="max-height: 150px; overflow-y: auto;">
            <table class="rel-table"><tbody id="c-rel-body"></tbody></table>
        </div>
        <div style="margin-top:15px;">
            <button id="editBtn" onclick="editCurrentNode()" style="background:#f0f0f0; color:#444; border:1px solid #ccc; display:none">ä¿®æ”¹èµ„æ–™</button>
            <button id="delNodeBtn" onclick="deleteCurrentNode()" style="background:#dc3545; color:white; display:none; margin-top:5px">âš ï¸ åˆ é™¤æ­¤äººåŠå…¶å…³ç³»</button>
            <button onclick="resetFocus()" style="background:var(--success); margin-top:5px">æ¢å¤å®Œæ•´è§†å›¾</button>
            <button onclick="closeCard()" style="background:#eee; color:#666; margin-top:5px">å…³é—­</button>
        </div>
    </div>

    <div id="link-pop" class="link-tooltip"></div>
    <div id="3d-graph"></div>

    <script>
        const SB_URL = 'https://qemyaqsxlkxpxvmlzhli.supabase.co';
        const SB_KEY = 'sb_publishable_QB7wPNVsq0olx3opmZXDzA_83yJm1qD';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let gData = { nodes: [], links: [] };
        let focusNode = null;
        let tempImgBase64 = "";
        let isAdmin = false;

        // å…³ç³»çº¿æ ·å¼ï¼šä½¿ç”¨åŸç‰ˆæ·±è‰²ç³»é…è‰²
        const REL_STYLE = {
            'cp': { color: '#B3005F' },
            'å¥½å‹': { color: '#006400' },
            'é˜Ÿå‹': { color: '#005F6B' },
            'å®¤å‹': { color: '#A0522D' },
            'becp': { color: '#310062' },
            'ä»‡äºº': { color: '#800000' }
        };

        const Graph = ForceGraph3D()(document.getElementById('3d-graph'));

        Graph.backgroundColor('#f0f8ff')
            .showNavInfo(false)
            .nodeThreeObject(node => {
                const group = new THREE.Group();
                const isFocus = focusNode && node.id === focusNode.id;
                const size = isFocus ? 11 : 7;
                const texture = new THREE.TextureLoader().load(node.avatar || `https://api.dicebear.com/7.x/initials/svg?seed=${node.id}`);
                const sphere = new THREE.Mesh(new THREE.SphereGeometry(size, 32, 32), new THREE.MeshLambertMaterial({ map: texture }));
                group.add(sphere);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 160; canvas.height = 50;
                ctx.fillStyle = isFocus ? 'rgba(0,123,255,1)' : 'rgba(80,80,80,1)';
                ctx.beginPath(); ctx.roundRect(0, 0, 160, 50, 12); ctx.fill();
                ctx.font = 'bold 24px Arial'; ctx.fillStyle = 'white'; ctx.textAlign = 'center';
                ctx.fillText(node.id, 80, 33);
                const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas) }));
                sprite.position.y = size + 8; sprite.scale.set(16, 5, 1);
                group.add(sprite);
                return group;
            })
            // ç§»æ¤åŸç‰ˆï¼šå¤„ç†å¤šé‡å…³ç³»çš„å¼§åº¦ç®—æ³•
            .linkCurvature(link => {
                const idA = link.source.id || link.source;
                const idB = link.target.id || link.target;
                const siblings = gData.links.filter(l => {
                    const s = l.source.id || l.source; const t = l.target.id || l.target;
                    return (s === idA && t === idB) || (s === idB && t === idA);
                });
                return siblings.length <= 1 ? 0 : (siblings.indexOf(link) - (siblings.length - 1) / 2) * 0.25;
            })
            // çº¿æ¡è§†è§‰ä¿®å¤ï¼šä¿æŒ0.8çº¿å®½ï¼Œä½¿ç”¨ä¸é€æ˜æè´¨ + è‡ªå‘å…‰å¢å¼ºè‰²æ·±
            .linkColor(link => REL_STYLE[link.type]?.color || '#333333')
            .linkWidth(0.8)
            .linkMaterial(link => {
                const color = REL_STYLE[link.type]?.color || '#333333';
                return new THREE.MeshLambertMaterial({
                    color: color,
                    transparent: false, // ç¦ç”¨é€æ˜ï¼Œè§£å†³é€å…‰é—®é¢˜
                    opacity: 1,         // æ»¡ä¸é€æ˜åº¦
                    emissive: color,    // æ·»åŠ è‡ªå‘å…‰ï¼Œé˜²æ­¢æ·±è‰²åœ¨çº¿æ¡å¤ªç»†æ—¶å˜ç°
                    emissiveIntensity: 0.4
                });
            })
            .nodeVisibility(node => {
                if (!focusNode) return true;
                return node.id === focusNode.id || gData.links.some(l =>
                    ((l.source.id || l.source) === focusNode.id && (l.target.id || l.target) === node.id) ||
                    ((l.target.id || l.target) === focusNode.id && (l.source.id || l.source) === node.id)
                );
            })
            .linkVisibility(link => {
                if (!focusNode) return true;
                const sId = link.source.id || link.source;
                const tId = link.target.id || link.target;
                return sId === focusNode.id || tId === focusNode.id;
            })
            .onNodeClick(node => { focusNode = node; showDetail(node); refreshGraph(); })
            .onLinkClick((link, event) => {
                const pop = document.getElementById('link-pop');
                pop.innerHTML = `<b style="color:${REL_STYLE[link.type]?.color || '#333'}">ã€${link.type}ã€‘</b><br>${link.desc || 'æœªè¾“å…¥è¯¦ç»†èƒŒæ™¯'}`;
                pop.style.display = 'block';
                pop.style.left = (event.clientX + 20) + 'px'; pop.style.top = (event.clientY + 20) + 'px';
                setTimeout(() => { pop.style.display = 'none'; }, 4000);
            });

        // æ•°æ®åŠ è½½ä¸è¯Šæ–­æ¸…æ´—é€»è¾‘
        async function loadData() {
            console.log("ğŸ“¡ æ­£åœ¨è°ƒå–äº‘ç«¯æ•°æ®...");
            const { data, error } = await sb.from('relation_graphs').select('data').eq('id', 1).single();
            if (error) {
                document.getElementById('sync-text').innerText = "âŒ æ•°æ®åº“è¯»å–å¼‚å¸¸";
                return;
            }
            if (data && data.data) {
                gData = data.data;
                cleanNodePositions(); 
                setTimeout(() => {
                    Graph.graphData(gData);
                    document.getElementById('sync-text').innerText = "âœ… æ•°æ®å·²å¯¹é½";
                }, 100);
            }
            checkAdmin();
        }

        async function saveData() {
            if (!isAdmin) return;
            document.getElementById('sync-text').innerText = "â³ åŒæ­¥ä¸­...";
            const exportData = JSON.parse(JSON.stringify(gData));
            // å½»åº•æ¸…æ´—åæ ‡å¼•ç”¨ï¼Œç¡®ä¿ä¸‹æ¬¡åŠ è½½é‡æ–°å¸ƒå±€
            exportData.nodes.forEach(n => {
                ['x','y','z','vx','vy','vz','fx','fy','fz'].forEach(prop => delete n[prop]);
            });
            exportData.links.forEach(l => {
                if (typeof l.source === 'object') l.source = l.source.id;
                if (typeof l.target === 'object') l.target = l.target.id;
            });
            const { error } = await sb.from('relation_graphs').update({ data: exportData }).eq('id', 1);
            document.getElementById('sync-text').innerText = error ? "âŒ å¤±è´¥" : "âœ… å·²åŒæ­¥";
        }

        function cleanNodePositions() {
            gData.nodes.forEach(n => {
                ['x','y','z','vx','vy','vz','fx','fy','fz'].forEach(p => delete n[p]);
            });
            gData.links.forEach(l => {
                if (typeof l.source === 'object') l.source = l.source.id;
                if (typeof l.target === 'object') l.target = l.target.id;
            });
        }

        function refreshGraph() {
            cleanNodePositions();
            Graph.graphData(gData);
        }

        // ä¸šåŠ¡äº¤äº’é€»è¾‘
        function addNode() {
            const name = document.getElementById('nodeName').value.trim();
            if (!name) return alert('å§“åå¿…å¡«');
            const avatar = tempImgBase64 || document.getElementById('nodeAvatar').value.trim();
            const nicks = document.getElementById('nodeNick').value.split(/[,ï¼Œ]/).filter(t => t.trim());
            const desc = document.getElementById('nodeDesc').value.trim();
            let node = gData.nodes.find(n => n.id === name);
            if (node) Object.assign(node, { avatar, nicks, desc });
            else gData.nodes.push({ id: name, avatar, nicks, desc });
            refreshGraph(); saveData(); resetForm();
        }

        function deleteCurrentNode() {
            if (!focusNode) return;
            if (confirm(`ç¡®å®šè¦åˆ é™¤ã€${focusNode.id}ã€‘å—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤ç›¸å…³å…³ç³»çº¿ã€‚`)) {
                const targetId = focusNode.id;
                gData.nodes = gData.nodes.filter(n => n.id !== targetId);
                gData.links = gData.links.filter(l => (l.source.id || l.source) !== targetId && (l.target.id || l.target) !== targetId);
                closeCard(); refreshGraph(); saveData();
            }
        }

        function addLink() {
            const s = document.getElementById('source').value.trim();
            const t = document.getElementById('target').value.trim();
            const type = document.getElementById('relType').value;
            const desc = document.getElementById('relDesc').value.trim();
            if (!gData.nodes.some(n => n.id === s) || !gData.nodes.some(n => n.id === t)) return alert("è§’è‰²æœªå½•å…¥");
            gData.links.push({ source: s, target: t, type, desc });
            refreshGraph(); saveData();
        }

        function showDetail(node) {
            document.getElementById('c-avatar').src = node.avatar || `https://api.dicebear.com/7.x/initials/svg?seed=${node.id}`;
            document.getElementById('c-name').innerText = node.id;
            document.getElementById('c-desc').innerText = node.desc || 'æš‚æ— è¯¦ç»†èƒŒæ™¯ä»‹ç»ã€‚';
            document.getElementById('c-nicks').innerHTML = (node.nicks || []).map(n => `<span class="tag">#${n}</span>`).join('');
            const myLinks = gData.links.filter(l => (l.source.id || l.source) === node.id || (l.target.id || l.target) === node.id);
            document.getElementById('c-rel-body').innerHTML = myLinks.map(l => {
                const other = (l.source.id || l.source) === node.id ? (l.target.id || l.target) : (l.source.id || l.source);
                const delBtn = isAdmin ? `<td><span style="color:red;cursor:pointer" onclick="deleteLinkByIndex(${gData.links.indexOf(l)})">åˆ é™¤</span></td>` : '';
                return `<tr><td><b>${other}</b></td><td style="color:${REL_STYLE[l.type]?.color || '#333'}"><b>${l.type}</b></td>${delBtn}</tr>`;
            }).join('');
            document.getElementById('detail-card').style.display = 'block';
        }

        function deleteLinkByIndex(idx) {
            if(confirm("ç¡®å®šå½»åº•åˆ é™¤è¿™æ®µå…³ç³»ï¼Ÿ")) {
                gData.links.splice(idx, 1);
                refreshGraph(); saveData();
                if(focusNode) showDetail(focusNode);
            }
        }

        function handleImg(input) {
            const reader = new FileReader();
            reader.onload = (e) => { tempImgBase64 = e.target.result; document.getElementById('nodeAvatar').value = "å›¾ç‰‡å·²è¯»å–"; };
            reader.readAsDataURL(input.files[0]);
        }

        async function checkAdmin() {
            const { data: { user } } = await sb.auth.getUser();
            if (user) {
                isAdmin = true;
                document.getElementById('ui-panel').style.display = 'block';
                document.getElementById('editBtn').style.display = 'block';
                document.getElementById('delNodeBtn').style.display = 'block';
            }
        }

        function handleSecretClick() {
            window.cnt = (window.cnt || 0) + 1;
            if (window.cnt >= 3) {
                const email = prompt("ç®¡ç†å‘˜é‚®ç®±:"); const pw = prompt("å¯†ç :");
                if(email && pw) {
                    sb.auth.signInWithPassword({ email, password: pw }).then(({error}) => {
                        if (!error) location.reload(); else alert("éªŒè¯æœªé€šè¿‡");
                    });
                }
            }
            setTimeout(() => { window.cnt = 0; }, 1000);
        }

        function handleSearch(val) {
            if (!val) { resetFocus(); return; }
            const n = gData.nodes.find(n => n.id.includes(val) || (n.nicks && n.nicks.some(nick => nick.includes(val))));
            if (n) { focusNode = n; showDetail(n); refreshGraph(); }
        }

        async function logout() { await sb.auth.signOut(); location.reload(); }
        function editCurrentNode() { document.getElementById('nodeName').value = focusNode.id; document.getElementById('nodeNick').value = (focusNode.nicks || []).join(','); document.getElementById('nodeDesc').value = focusNode.desc || ''; }
        function resetFocus() { focusNode = null; refreshGraph(); }
        function closeCard() { document.getElementById('detail-card').style.display = 'none'; resetFocus(); }
        function resetForm() { ['nodeName', 'nodeNick', 'nodeAvatar', 'nodeDesc'].forEach(id => document.getElementById(id).value = ''); tempImgBase64 = ""; }

        window.onload = loadData;
    </script>
</body>
</html>
